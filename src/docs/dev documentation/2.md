# Proceso detallado de creación del menú de capas

Este proceso se crean los componentes que componen el menú de capas. Dentro de `src/js/entities.js`

## Componentes clave del menú

### 1. Item
Representa una capa individual en el menú.

- **Propiedades principales**: 
  - `nombre`: Identificador único de la capa
  - `keywords`: Palabras clave para búsqueda
  - `titulo`: Título visible en el menú
  - `capa`: Objeto que contiene la información de la capa (tipo `Capa` o `CapaMapserver`)

- **Métodos importantes**:
  - `setImpresor(impresor)`: Asigna el objeto responsable de renderizar el ítem en el DOM

### 2. ItemGroup
Agrupa varios Items, generalmente representando una sección del menú.

- **Propiedades principales**:
  - `tab`, `name`, `section`, `weight`: Determinan la posición y estructura en el menú
  - `items`: Array de objetos Item

- **Métodos importantes**:
  - `setItem(item)`: Añade un Item al grupo
  - `setImpresor(impresor)`: Asigna el objeto responsable de renderizar el grupo en el DOM

### 3. Impresores
Clases como `ImpresorItemHTML` e `ImpresorGrupoHTML` que se encargan de la representación visual.

- **Responsabilidad**: Convertir los objetos Item e ItemGroup en elementos HTML para su visualización

## Flujo detallado de creación del menú

1. **Inicialización**:
   - Se crea una instancia de `LayersInfoWMS` o `LayersInfoWMTS` con los parámetros necesarios (host, service, version, etc.).

2. **Llamada a `get(_gestorMenu)`**:
   - Este método inicia el proceso de obtención y procesamiento de las capas.
   - Si hay capas personalizadas y se usa inicialización perezosa, se crean Items directamente.
   - En caso contrario, se llama a `_parseRequest(_gestorMenu)`.

3. **Ejecución de `_parseRequest(_gestorMenu)`**:
   - Realiza una solicitud AJAX para obtener el documento de capacidades (GetCapabilities) del servicio WMS/WMTS.
   - Una vez recibida la respuesta, se procesa el XML:
     a. Se extraen metadatos generales (keywords, abstract).
     b. Se itera sobre cada capa en el XML.

4. **Procesamiento de cada capa**:
   - Para cada capa en el XML, se llama a `_createMenuItem()`.
   - Este método extrae la información relevante de la capa (nombre, título, abstract, etc.).
   - Crea un objeto `Capa` o `CapaMapserver` usando `_createCapaObject()`.
   - Construye un objeto `Item` con la información de la capa.
   - Asigna un `ImpresorItemHTML` al Item para su renderización.

5. **Creación del ItemGroup**:
   - Después de procesar todas las capas, se llama a `_createAndAddItemGroup()`.
   - Este método crea un nuevo `ItemGroup` con los metadatos generales.
   - Añade todos los Items creados al `ItemGroup`.
   - Asigna un `ImpresorGrupoHTML` al ItemGroup para su renderización.

6. **Adición al gestor de menú**:
   - El `ItemGroup` completo se añade al `_gestorMenu` usando `addItemGroup()`.

7. **Renderización**:
   - Dependiendo del modo de inicialización (perezoso o no), se llama a `printOnlySection()` o `printMenu()` en el `_gestorMenu`.
   - Estos métodos utilizan los Impresores asignados a cada Item y ItemGroup para generar el HTML del menú.

## Interacción entre componentes

- **LayersInfo -> Item**: La clase LayersInfo (y sus subclases) son responsables de crear los objetos Item basándose en la información de las capas.

- **Item -> ItemGroup**: Los Items se agrupan dentro de un ItemGroup, que representa una sección lógica del menú.

- **ItemGroup -> _gestorMenu**: El ItemGroup completo se añade al gestor de menú, que maneja la estructura general.

- **Impresores -> DOM**: Los Impresores asociados a Items e ItemGroups son los responsables finales de convertir estos objetos en elementos HTML en el DOM.

## Puntos de personalización y modificación

1. **Filtrado de capas**: 
   - Modifica `isAllowedLayer()` en LayersInfo para cambiar qué capas se incluyen en el menú.

2. **Personalización de la presentación de capas**:
   - Ajusta `formatLayerTitle()` y `formatLayerAbstract()` en LayersInfo para cambiar cómo se muestran los títulos y descripciones.

3. **Modificación de la estructura del menú**:
   - Cambia la lógica en `_createAndAddItemGroup()` para alterar cómo se agrupan las capas.

4. **Cambios en la renderización**:
   - Crea nuevas clases de Impresores que extiendan de las existentes y asígnalas a los Items o ItemGroups para cambiar cómo se genera el HTML.

5. **Adición de nuevos tipos de servicios**:
   - Crea una nueva subclase de LayersInfo, siguiendo el patrón de LayersInfoWMS y LayersInfoWMTS, para soportar nuevos tipos de servicios de mapas.